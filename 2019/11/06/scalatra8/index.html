<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="a personal blog"><title>Scalatra in Action 8. 测试工程师要了杯啤酒 | Not determined yet</title><link rel="stylesheet" type="text/css" href="/blog/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/blog/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/blog/favicon.ico"><link rel="apple-touch-icon" href="/blog/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/blog/apple-touch-icon.png"><script src="https://www.googletagmanager.com/gtag/js?id=G-N73FWWZR9G" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-N73FWWZR9G');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><style type="text/css">
.spoiler {
  display: inline-flex;
}
p.spoiler {
  display: flex;
}
.spoiler a {
  pointer-events: none;
}
.spoiler-blur, .spoiler-blur > * {
  transition: text-shadow .5s ease;
}
.spoiler .spoiler-blur, .spoiler .spoiler-blur > * {
  color: rgba(0, 0, 0, 0);
  background-color: rgba(0, 0, 0, 0);
  text-shadow: 0 0 10px grey;
  cursor: pointer;
}
.spoiler .spoiler-blur:hover, .spoiler .spoiler-blur:hover > * {
  text-shadow: 0 0 5px grey;
}
.spoiler-box, .spoiler-box > * {
  transition: color .5s ease,
  background-color .5s ease;
}
.spoiler .spoiler-box, .spoiler .spoiler-box > * {
  color: black;
  background-color: black;
  text-shadow: none;
}</style><meta name="generator" content="Hexo 6.1.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Scalatra in Action 8. 测试工程师要了杯啤酒</h1><a id="logo" href="/blog/.">Not determined yet</a><p class="description">知其强，守其弱，为天下菜，为天下菜，可以下饭。</p></div><div id="nav-menu"><a class="current" href="/blog/."><i class="fa fa-home"> 首页</i></a><a href="/blog/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/blog/about/"><i class="fa fa-user"> 关于</i></a><a href="/blog/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><div class="alert alert-danger" role="alert"><i class="fa fa-exclamation-triangle warning"> 本文发表的时间过于久远，其中的信息可能已经有所发展或者不再适用于现阶段</i></div><h1 class="post-title">Scalatra in Action 8. 测试工程师要了杯啤酒</h1><div class="post-meta">2019-11-06<span> | </span><span class="category"><a href="/blog/categories/%E6%8A%80%E6%9C%AF/">技术</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.8k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 13</span><span class="post-meta-item-text"> 分钟</span></span></span></div><a class="disqus-comment-count" data-disqus-identifier="2019/11/06/scalatra8/" href="/blog/2019/11/06/scalatra8/#disqus_thread"></a><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>现在我们对Scalatra的基本功能都有了一定的了解，现在是时候了解测试了。</p>
<p>Scalatra的设计理念就是能够方便地使用你想要地插件，比如测试这里，你可以用ScalaTest或者Specs2或者任何你想要使用的测试框架。</p>
<p>下面将分别介绍这两者。</p>
<h2 id="Specs2"><a href="#Specs2" class="headerlink" title="Specs2"></a>Specs2</h2><p>Scalatra是基于Java Servlet 构建的，尽管这使得它能够很好的支持像Jetty和Tomcat这样的服务器</p>
<p>但它同样给测试带来了以下的复杂度</p>
<ul>
<li>Servlet的主要方法的返回值都是Unit类型，这意味着我们需要检测其中对象的状态的变化</li>
<li>API的函数过多，很难跟踪到具体位置，以3.0版本的<code>HttpServletRequest</code>为例，就有<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-7.0-doc/servletapi/javax/servlet/http/HttpServletRequestWrapper.html">87个</a>(算上重载的函数)</li>
<li>Servlet的规范限制了不能在任意时刻调用方法，所以很难模拟数据</li>
</ul>
<p>由于以上原因，直接测试应用的Servlet层是相当困难的，Scalatra给出的解决方式是，通过DSL，调用HTTP客户端，与其内嵌的Servlet容器来通信。</p>
<h3 id="引入Specs2依赖"><a href="#引入Specs2依赖" class="headerlink" title="引入Specs2依赖"></a>引入Specs2依赖</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libraryDependencies ++= <span class="type">Seq</span>(</span><br><span class="line">  <span class="string">&quot;org.scalatra&quot;</span> %% <span class="string">&quot;scalatra-specs2&quot;</span> % <span class="type">ScalatraVersion</span> % <span class="string">&quot;test&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>上述代码添加至<code>build.sbt</code>的合适位置即可引入依赖，注意到这里最后多了<code>% &quot;test&quot;</code>，</p>
<p>这是声明这个依赖只能在测试时被访问，这样做的好处之一时避免在生产环境中引入不必要的依赖，增加复杂度</p>
<p>默认测试类的存放路径为<code>src/test/scala</code>(<a target="_blank" rel="noopener" href="https://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html">Maven 惯例</a>)</p>
<p>下面我们以测试一个json结果为例，需要先引入对应的json依赖(json4s和Scalatra json集成组件)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">libraryDependencies ++= <span class="type">Seq</span>(</span><br><span class="line">  <span class="string">&quot;org.scalatra&quot;</span> %% <span class="string">&quot;scalatra-json&quot;</span> % <span class="type">ScalatraVersion</span>,</span><br><span class="line">  <span class="string">&quot;org.json4s&quot;</span> %% <span class="string">&quot;json4s-jackson&quot;</span> % <span class="string">&quot;3.3.0&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>(尽管<code>json4s-jackson</code>已经有了<a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/org.json4s/json4s-jackson">更新的版本</a>, 这里为了防止版本不兼容可能导致的问题，沿用了书上较旧的版本)</p>
<p>我们来看下面的代码</p>
<p>这是第一部分，控制主要逻辑，当用户访问<code>/foods/potatoes</code>时，返回一个json文本</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;potatoes&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fairTrade&quot;</span><span class="punctuation">:</span><span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;vegetable&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;tuber&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.app</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json4s.<span class="type">DefaultFormats</span></span><br><span class="line"><span class="keyword">import</span> org.json4s.<span class="type">JsonDSL</span>._</span><br><span class="line"><span class="keyword">import</span> org.scalatra.<span class="type">ScalatraServlet</span></span><br><span class="line"><span class="keyword">import</span> org.scalatra.json.<span class="type">JacksonJsonSupport</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/main/scala/com.example.app/FoodServlet.scala</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FoodServlet</span> <span class="keyword">extends</span> <span class="title">ScalatraServlet</span> <span class="keyword">with</span> <span class="title">JacksonJsonSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">lazy</span> <span class="keyword">val</span> jsonFormats: <span class="type">DefaultFormats</span>.<span class="keyword">type</span> = <span class="type">DefaultFormats</span></span><br><span class="line"></span><br><span class="line">  get(<span class="string">&quot;/foods/potatoes&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> productJson =</span><br><span class="line">      (<span class="string">&quot;name&quot;</span> -&gt; <span class="string">&quot;potatoes&quot;</span>) ~</span><br><span class="line">        (<span class="string">&quot;fairTrade&quot;</span> -&gt; <span class="literal">true</span>) ~</span><br><span class="line">        (<span class="string">&quot;tags&quot;</span> -&gt; <span class="type">List</span>(<span class="string">&quot;vegetable&quot;</span>, <span class="string">&quot;tuber&quot;</span>))</span><br><span class="line">    productJson</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要稍微修改一下程序的入口</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.app.<span class="type">FoodServlet</span></span><br><span class="line"><span class="keyword">import</span> org.scalatra._</span><br><span class="line"><span class="keyword">import</span> javax.servlet.<span class="type">ServletContext</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/main/scala/ScalatraBootstrap.scala </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScalatraBootstrap</span> <span class="keyword">extends</span> <span class="title">LifeCycle</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">init</span></span>(context: <span class="type">ServletContext</span>) &#123;</span><br><span class="line">    context.mount(<span class="keyword">new</span> <span class="type">FoodServlet</span>, <span class="string">&quot;/*&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里可能会有点疑问，如果程序入口不叫<code>ScalatraBootstrap</code>行吗，当然可以，只要修改</p>
<p><code>web.xml</code>,添加<code>context-param.param-value</code>就行了</p>
<p>详细可以参考<a target="_blank" rel="noopener" href="http://scalatra.org/guides/2.6/deployment/configuration.html">官方文档</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee </span></span></span><br><span class="line"><span class="string"><span class="tag">  http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">version</span>=<span class="string">&quot;3.1&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>org.scalatra.LifeCycle<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.yourdomain.project.MyScalatraBootstrap<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.scalatra.servlet.ScalatraListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>有了这两段代码，我们的“web应用”（袖珍版）就能在浏览器上跑了。</p>
<p>现在是一个很简单的程序，但是如果以后要在这上面开发新的功能，如何保证引入的新代码不会破坏就有的功能呢？</p>
<p>这就需要写测试了。</p>
<p>有了测试，我们能更加放心地往上面开(hu)发(shi)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.app</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.scalatra.test.specs2.<span class="type">ScalatraSpec</span></span><br><span class="line"><span class="keyword">import</span> org.specs2.matcher.<span class="type">MatchResult</span></span><br><span class="line"><span class="keyword">import</span> org.specs2.specification.core.<span class="type">SpecStructure</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FoodServletSpec</span> <span class="keyword">extends</span> <span class="title">ScalatraSpec</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">potatoesOk</span></span>: <span class="type">MatchResult</span>[<span class="type">Any</span>] =</span><br><span class="line">    get(<span class="string">&quot;/foods/potatoes&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// Assert that the status of response was 200(OK)</span></span><br><span class="line">      status must_== <span class="number">200</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Specs2 syntax describes what will be asserted</span></span><br><span class="line">  <span class="comment">// using string to describe the test</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is</span></span>: <span class="type">SpecStructure</span> =</span><br><span class="line">    s2<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">         GET /foods/potatoes on FoodServlet</span></span><br><span class="line"><span class="string">         should return status 200</span></span><br><span class="line"><span class="string">      $potatoesOk</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Mounts the servlet to the root path so it can be called</span></span><br><span class="line">  addServlet(classOf[<span class="type">FoodServlet</span>], <span class="string">&quot;/*&quot;</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里面有一个奇怪的语法需要讲解下。</p>
<p>如果你熟悉Scala的字符串插值，如<code>s&quot;my name is $name&quot;</code>, 那么对接下来的部分会更容易理解。</p>
<p><code>s2</code>这个前缀使用Scala自定义字符串插值的特性，来实现把测试的描述从代码中分离的功能。</p>
<p>在这段代码中，<code>is</code>不是一个字符串，而是会被转换成一个Spec2的数据结构<code>Fragments</code>.</p>
<p>这个数据结构用来具体描述测试样例。</p>
<p>详细的内容可以参考这篇<a target="_blank" rel="noopener" href="http://etorreborre.blogspot.com/2013/05/the-latest-release-of-specs2-2.html">博客</a></p>
<p>上面的测试样例只是对比了HTTP的返回码，并没有考虑到其他的要素，下面的部分会针对这里做详细的展开。</p>
<h3 id="HTTP-response-断言"><a href="#HTTP-response-断言" class="headerlink" title="HTTP response 断言"></a>HTTP response 断言</h3><p>HTTP response 可以看作由如下几部分组成：</p>
<ul>
<li>状态码</li>
<li>HTTP头</li>
<li>消息体</li>
</ul>
<p>下面是更加详细的测试断言</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.app</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.scalatra.test.specs2.<span class="type">ScalatraSpec</span></span><br><span class="line"><span class="keyword">import</span> org.specs2.matcher._</span><br><span class="line"><span class="keyword">import</span> org.specs2.specification.core.<span class="type">SpecStructure</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FoodServletSpec</span> <span class="keyword">extends</span> <span class="title">ScalatraSpec</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is</span></span>: <span class="type">SpecStructure</span> =</span><br><span class="line">    s2<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">         GET /foods/potatoes on FoodServlet</span></span><br><span class="line"><span class="string">         should return status 200     $potatoesOk</span></span><br><span class="line"><span class="string">         should be JSON               $potatoesJSON</span></span><br><span class="line"><span class="string">         should contain name potatoes $potatoesName</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  addServlet(classOf[<span class="type">FoodServlet</span>], <span class="string">&quot;/*&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> testURL = <span class="string">&quot;/foods/potatoes&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">potatoesOk</span></span>: <span class="type">MatchResult</span>[<span class="type">Any</span>] =</span><br><span class="line">    get(testURL) &#123;</span><br><span class="line">      status must_== <span class="number">200</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">potatoesJSON</span></span>: <span class="type">MatchResult</span>[<span class="type">String</span>] = get(testURL) &#123;</span><br><span class="line">    header(<span class="string">&quot;Content-Type&quot;</span>) must startWith(<span class="string">&quot;application/json;&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">potatoesName</span></span>: <span class="type">MatchResult</span>[<span class="type">String</span>] = get(testURL) &#123;</span><br><span class="line">    body must contain(<span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;potatoes\&quot;&#125;&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这部分的测试用来对比json字符串的方法是用string来做间接的比较，有没有办法直接比较json呢？</p>
<h3 id="用JValues进行测试"><a href="#用JValues进行测试" class="headerlink" title="用JValues进行测试"></a>用JValues进行测试</h3><p>我们之前也讲过关于json的使用，这里就不赘述了，直接给代码</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.json4s._</span><br><span class="line"><span class="keyword">import</span> org.json4s.jackson.<span class="type">JsonMethods</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FoodServletSpec</span> <span class="keyword">extends</span> <span class="title">ScalatraSpec</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">potatoesName</span></span>: <span class="type">MatchResult</span>[<span class="type">Any</span>] = get(testURL) &#123;</span><br><span class="line">    <span class="keyword">val</span> json = <span class="type">JsonMethods</span>.parse(body)</span><br><span class="line">    json \ <span class="string">&quot;name&quot;</span> must_== <span class="type">JString</span>(<span class="string">&quot;potatoes&quot;</span>)</span><br><span class="line">    json \ <span class="string">&quot;fairTrade&quot;</span> must_== <span class="type">JBool</span>(<span class="literal">true</span>)</span><br><span class="line">    json \ <span class="string">&quot;tags&quot;</span> must_== <span class="type">JArray</span>(<span class="type">List</span>(<span class="type">JString</span>(<span class="string">&quot;vegetable&quot;</span>), <span class="type">JString</span>(<span class="string">&quot;tuber&quot;</span>)))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>懒出效率是程序员的美德</p>
</blockquote>
<p>考虑一下，上面的代码是不是有重复的部分可以提取。</p>
<p>假如我们要测试多个不同的json数据，每次都要从HTTP response 中的body中将数据转换成json格式，这一步代码就会一直写。</p>
<p>一个简单的方法是把这部分提取出来。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.json4s.<span class="type">JValue</span></span><br><span class="line"><span class="keyword">import</span> org.json4s.jackson.<span class="type">JsonMethods</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">JsonBodySupport</span> </span>&#123; </span><br><span class="line">  <span class="comment">// Requires that children are Scalatra tests</span></span><br><span class="line">  self: <span class="type">ScalatraTests</span> =&gt;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">jsonBody</span></span>: <span class="type">JValue</span> = <span class="type">JsonMethods</span>.parse(body)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FoodServletSpec</span> <span class="keyword">extends</span> <span class="title">ScalatraSpec</span> <span class="keyword">with</span> <span class="title">JsonBodySupport</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">potatoesName</span> </span>= get(<span class="string">&quot;/foods/potatoes&quot;</span>) &#123;</span><br><span class="line">    jsonBody \ <span class="string">&quot;name&quot;</span> must_== <span class="type">JString</span>(<span class="string">&quot;potatos&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里用到了Scala的一个特性：<a target="_blank" rel="noopener" href="https://docs.scala-lang.org/tour/self-types.html">self-type</a></p>
<p>我们来看这部分<code>self: ScalatraTests</code>,这里声明了，任何一个继承<code>JsonBoadySupport</code>的类，也一定是ScalatraTests的子类。</p>
<p>也就是说，下面这种定义，是行不通的</p>
<p><code>class FoodServletSpec extends JsonBodySupport</code></p>
<p>IDE会报错：”illegal inheritance self-type does not conform to ScalaTests”</p>
<p>加上<code>extends ScalatraSpec</code>则不同，因为</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">ScalatraSpec</span> <span class="keyword">extends</span> <span class="title">SpecificationLike</span> <span class="keyword">with</span> <span class="title">BaseScalatraSpec</span></span></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">BaseScalatraSpec</span> <span class="keyword">extends</span> <span class="title">BeforeAfterAll</span> <span class="keyword">with</span> <span class="title">ScalatraTests</span></span></span><br></pre></td></tr></table></figure>

<p>所以<code>ScalatraSpec</code>是<code>ScalaTests</code>的子类，可以正确地被定义。</p>
<p>那么下面的<code>JsonMethods.parse(body)</code>的”body”又是来自于哪里呢，这是因为</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">ScalatraTests</span> <span class="keyword">extends</span> <span class="title">EmbeddedJettyContainer</span> <span class="keyword">with</span> <span class="title">HttpComponentsClient</span> </span></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">HttpComponentsClient</span> <span class="keyword">extends</span> <span class="title">Client</span></span></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Client</span> <span class="keyword">extends</span> <span class="title">ImplicitConversions</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">body</span> </span>= response.body</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过如下改造后，我们新的测试代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.app</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json4s._</span><br><span class="line"><span class="keyword">import</span> org.json4s.jackson.<span class="type">JsonMethods</span></span><br><span class="line"><span class="keyword">import</span> org.scalatra.test.<span class="type">ScalatraTests</span></span><br><span class="line"><span class="keyword">import</span> org.scalatra.test.specs2.<span class="type">ScalatraSpec</span></span><br><span class="line"><span class="keyword">import</span> org.specs2.matcher._</span><br><span class="line"><span class="keyword">import</span> org.specs2.specification.core.<span class="type">SpecStructure</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">JsonBodySupport</span> </span>&#123;</span><br><span class="line">  sf: <span class="type">ScalatraTests</span> =&gt;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">jsonBody</span></span>: <span class="type">JValue</span> = <span class="type">JsonMethods</span>.parse(body)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FoodServletSpec</span> <span class="keyword">extends</span> <span class="title">ScalatraSpec</span> <span class="keyword">with</span> <span class="title">JsonBodySupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is</span></span>: <span class="type">SpecStructure</span> =</span><br><span class="line">    s2<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">         GET /foods/potatoes on FoodServlet</span></span><br><span class="line"><span class="string">         should return status 200     $potatoesOk</span></span><br><span class="line"><span class="string">         should be JSON               $potatoesJSON</span></span><br><span class="line"><span class="string">         should contain name potatoes $potatoesName</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  addServlet(classOf[<span class="type">FoodServlet</span>], <span class="string">&quot;/*&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> testURL = <span class="string">&quot;/foods/potatoes&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">potatoesOk</span></span>: <span class="type">MatchResult</span>[<span class="type">Any</span>] =</span><br><span class="line">    get(testURL) &#123;</span><br><span class="line">      status must_== <span class="number">200</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">potatoesJSON</span></span>: <span class="type">MatchResult</span>[<span class="type">String</span>] = get(testURL) &#123;</span><br><span class="line">    header(<span class="string">&quot;Content-Type&quot;</span>) must startWith(<span class="string">&quot;application/json;&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">potatoesName</span></span>: <span class="type">MatchResult</span>[<span class="type">Any</span>] = get(testURL) &#123;</span><br><span class="line">    jsonBody \ <span class="string">&quot;name&quot;</span> must_== <span class="type">JString</span>(<span class="string">&quot;potatoes&quot;</span>)</span><br><span class="line">    jsonBody \ <span class="string">&quot;fairTrade&quot;</span> must_== <span class="type">JBool</span>(<span class="literal">true</span>)</span><br><span class="line">    jsonBody \ <span class="string">&quot;tags&quot;</span> must_== <span class="type">JArray</span>(<span class="type">List</span>(<span class="type">JString</span>(<span class="string">&quot;vegetable&quot;</span>), <span class="type">JString</span>(<span class="string">&quot;tuber&quot;</span>)))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h3><p>现在，我们可以进行简单的测试了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">sbt <span class="built_in">test</span></span></span><br></pre></td></tr></table></figure>
<p>shell会输出类似下面的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[info] FoodServletSpec</span><br><span class="line">[info]          + GET /foods/potatoes on FoodServlet</span><br><span class="line">[info]            should return status 200</span><br><span class="line">[info]          + should be JSON</span><br><span class="line">[info]          + should contain name potatoes</span><br><span class="line">[info] Total for specification FoodServletSpec</span><br><span class="line">[info] Finished in 850 ms</span><br><span class="line">[info] 3 examples, 5 expectations, 0 failure, 0 error</span><br><span class="line">20:00:21.390 [pool-26-thread-6] INFO  o.e.j.server.handler.ContextHandler - Stopped o.e.j.s.ServletContextHandler@6b12f7dd&#123;/,file:///D:/IdeaProjects/scala/scalatra1/src/main/webapp/,UNAVAILABLE&#125;</span><br><span class="line">[info] MyScalatraServletTests:</span><br><span class="line">[info] - GET / on MyScalatraServlet should return status 200</span><br><span class="line">[info] ScalaTest</span><br><span class="line">[info] Run completed in 2 seconds, 229 milliseconds.</span><br><span class="line">[info] Total number of tests run: 1</span><br><span class="line">[info] Suites: completed 1, aborted 0</span><br><span class="line">[info] Tests: succeeded 1, failed 0, canceled 0, ignored 0, pending 0</span><br><span class="line">[info] All tests passed.</span><br><span class="line">[info] Passed: Total 4, Failed 0, Errors 0, Passed 4</span><br><span class="line">[success] Total time: 5 s, completed 2019-11-5 20:00:21</span><br></pre></td></tr></table></figure>

<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>单元测试有以下优点</p>
<ul>
<li>易写</li>
<li>易部署</li>
<li>运行更快</li>
</ul>
<p>下面通过业务代码来写一个单元测试</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.example.app.&#123;<span class="type">NukeLauncherServlet</span>, <span class="type">RealNukeLauncher</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.scalatra._</span><br><span class="line"><span class="keyword">import</span> javax.servlet.<span class="type">ServletContext</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/main/scala/ScalatraBootstrap.scala</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScalatraBootstrap</span> <span class="keyword">extends</span> <span class="title">LifeCycle</span> </span>&#123;</span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">init</span></span>(context: <span class="type">ServletContext</span>) &#123;</span><br><span class="line">    context.mount(<span class="keyword">new</span> <span class="type">NukeLauncherServlet</span>(<span class="type">RealNukeLauncher</span>), <span class="string">&quot;/nuke/*&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.app</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.scalatra.&#123;<span class="type">Forbidden</span>, <span class="type">ScalatraServlet</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/main/scala/coom.example.app/NukeLauncherServlet.scala</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NukeLauncherServlet</span>(<span class="params">launcher: <span class="type">NukeLauncher</span> </span>)</span></span><br><span class="line">  <span class="keyword">extends</span> <span class="type">ScalatraServlet</span> &#123;</span><br><span class="line">  <span class="keyword">val</span> <span class="type">NuclearCode</span> = <span class="string">&quot;password123&quot;</span></span><br><span class="line">  post(<span class="string">&quot;/launch&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (params(<span class="string">&quot;code&quot;</span>) == <span class="type">NuclearCode</span>)</span><br><span class="line">      launcher.launch()</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="type">Forbidden</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">NukeLauncher</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">launch</span></span>(): <span class="type">Unit</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">RealNukeLauncher</span> <span class="keyword">extends</span> <span class="title">NukeLauncher</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">launch</span></span>(): <span class="type">Unit</span> = println(<span class="string">&quot;launched success.&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StubNukeLauncher</span> <span class="keyword">extends</span> <span class="title">NukeLauncher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> isLaunched = <span class="literal">false</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">launch</span></span>(): <span class="type">Unit</span> = isLaunched = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们应该注意到，在<code>StubNukeLauncher</code>中定义了一个<strong>global var</strong> <code>isLaunched</code>,这在scala中是一个不推荐的用法。</p>
<p>因为这会破坏线程安全和难以追踪其变化原因。</p>
<p>这里由于单元测试里不存在并发，同时，为了方便从外部直接修改，以进行测试（生产环境中需要连接数据库等，但测试时不应该直接连生产数据库，而是使用模拟数据），所以使用了<code>var</code>来定义变量。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.app</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.scalatra.test.specs2.<span class="type">MutableScalatraSpec</span></span><br><span class="line"><span class="keyword">import</span> org.specs2.mutable.<span class="type">After</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/test/scala/com.example.app/NukeLanucherSpec.scala</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NukeLauncherSpec</span> <span class="keyword">extends</span> <span class="title">MutableScalatraSpec</span> <span class="keyword">with</span> <span class="title">After</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Runs the tests sequentially because the stub is stateful</span></span><br><span class="line">  sequential</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> stubLauncher = <span class="keyword">new</span> <span class="type">StubNukeLauncher</span></span><br><span class="line">  addServlet(<span class="keyword">new</span> <span class="type">NukeLauncherServlet</span>(stubLauncher), <span class="string">&quot;/*&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Cleans up the state between test runs</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">after</span></span>: <span class="type">Unit</span> = stubLauncher.isLaunched = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Factor out common logic</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">launch</span></span>[<span class="type">A</span>](code: <span class="type">String</span>)(f: =&gt; <span class="type">A</span>): <span class="type">A</span> =</span><br><span class="line">    post(<span class="string">&quot;/launch&quot;</span>, <span class="string">&quot;code&quot;</span> -&gt; code)(f)</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;The wrong pass code&quot;</span> should &#123;</span><br><span class="line">    <span class="string">&quot;respond with forbidden&quot;</span> in &#123;</span><br><span class="line">      launch(<span class="string">&quot;wrong&quot;</span>) &#123;</span><br><span class="line">        status must_== <span class="number">403</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="string">&quot;not launch the nukes&quot;</span> in &#123;</span><br><span class="line">      launch(<span class="string">&quot;wrong&quot;</span>) &#123;</span><br><span class="line">        stubLauncher.isLaunched must_== <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="string">&quot;The right pass code&quot;</span> should &#123;</span><br><span class="line">    <span class="string">&quot;launch the nukes&quot;</span> in &#123;</span><br><span class="line">      launch(<span class="string">&quot;password123&quot;</span>) &#123;</span><br><span class="line">        stubLauncher.isLaunched must_== <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>值得注意的是Spec2是默认用并行来执行测试的，这是为了节省测试时间，但是在这个测试时，如果进行并行操作，由于不同的POST请求在同时修改可变变量<code>isLaunched</code>，这有可能会导致测试失败。</p>
<p>所以需要把测试声明成并行的<code>sequential</code></p>
<h2 id="ScalaTest"><a href="#ScalaTest" class="headerlink" title="ScalaTest"></a>ScalaTest</h2><p>ScalaTest和Specs2也是常见的Scala测试框架，两者有很多相似的语法。</p>
<h3 id="引入ScalaTest依赖"><a href="#引入ScalaTest依赖" class="headerlink" title="引入ScalaTest依赖"></a>引入ScalaTest依赖</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libraryDependencies ++= <span class="type">Seq</span>(</span><br><span class="line">  <span class="string">&quot;org.scalatra&quot;</span> %% <span class="string">&quot;scalatra-scalatest&quot;</span> % <span class="type">ScalatraVersion</span> % <span class="string">&quot;test&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>测试代码如下</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.app</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json4s.<span class="type">JString</span></span><br><span class="line"><span class="keyword">import</span> org.scalatra.test.scalatest.<span class="type">ScalatraWordSpec</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FoodServletTest</span> <span class="keyword">extends</span> <span class="title">ScalatraWordSpec</span> <span class="keyword">with</span> <span class="title">JsonBodySupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  addServlet(classOf[<span class="type">FoodServlet</span>], <span class="string">&quot;/*&quot;</span>)</span><br><span class="line">  <span class="string">&quot;GET /foods/potatoes on FoodServlet&quot;</span> must &#123;</span><br><span class="line">    <span class="string">&quot;return status 200&quot;</span> in &#123;</span><br><span class="line">      get(<span class="string">&quot;/foods/potatoes&quot;</span>) &#123;</span><br><span class="line">        status should equal(<span class="number">200</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">&quot;be JSON&quot;</span> in &#123;</span><br><span class="line">      get(<span class="string">&quot;/foods/potatoes&quot;</span>) &#123;</span><br><span class="line">        header(<span class="string">&quot;Content-Type&quot;</span>) should startWith(<span class="string">&quot;application/json;&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">&quot;should have name potatoes&quot;</span> in &#123;</span><br><span class="line">      get(<span class="string">&quot;/foods/potatoes&quot;</span>) &#123;</span><br><span class="line">        jsonBody \ <span class="string">&quot;name&quot;</span> should equal(<span class="type">JString</span>(<span class="string">&quot;potatoes&quot;</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试和Specs2类似，这里就不赘述了。</p>
</div><div class="post-copyright"><script type="text/javascript" src="/blog/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/blog/css/copyright.css"><p><span>版权声明：</span><p>除另有声明外，本博客文章均采用 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><b>知识共享(Creative Commons) 署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</b></a> 进行许可。</p></p></div><br><script type="text/javascript" src="/blog/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://counter2015.github.io/blog/2019/11/06/scalatra8/" data-id="cl1jg9oof002vqjpv7lbua102" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKklEQVR42u3aW47jMAwEQN//0tkDZOLpluTFRCp9BYlf5QAEKfK64vV6W++/fjry/fjk3OuJhYGB8bWM1+1KHi6/8aez7j9HrwYDA+MARnvLsV/zOJk/GwYGBkYSBO+Pv+dhYGBgPMdok7/k+PwKGBgYZzJmytT5DbX/WotjYGB8IeO5bbL5z4/0NzAwML6K8SpXXtC27cw8yP5wNQwMjK0ZbalZlJTlEEab9mFgYJzDWBDmbsNrXriOHbkuWmNgYPxdRttunH+Itv1ZPAMGBsamjHbAa2y7v034krtf+VvHwMDYgtGmd227cebuC5JCDAyMTRnt2FZe3Lbt0mhDEAMDY2tGe5uxdDAP4m05/UMtjoGBsR1jJlzObJnlG2r3Z2FgYGDMfJOH13yA45eBMAwMjE0ZRVAbGgLLy9QFwxYYGBibMvJBrgUJ3GONBAwMjL0Z82F0ZuRrvnmAgYFxGqPdSssDa17ijpXWGBgYJzCSRuM1tNq26EzrFAMD4xzGqq23PH3MxzLqmREMDIztGHnjsEXm129TVQwMjNMYUfpVJnntC1qwX4iBgbEdYz5Ra4NyPopRXAEDA2NrRhtMxxqTM4Vx3kDFwMDYmzEWLudXG3B/+R8wMDAOYCThcqyIbUfH8tD/cdcQAwMDY2jrP29w5ldeFnAxMDA2ZdwncHlS2LZCFwdcDAyMr2K04xRt2jdTHkdgDAyMrRntIEVe0I6x8/YABgbGAYx/ypiyUM8y7xsAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/blog/tags读书笔记"><i class="fa fa-tag">读书笔记</i></a><a href="/blog/tagsScalatra"><i class="fa fa-tag">Scalatra</i></a></div><div class="post-nav"><a class="pre" href="/blog/2019/12/16/linux-io-scheduler/">Linux I/O调度器备忘</a><a class="next" href="/blog/2019/08/26/scalatra7/">Scalatra in Action 7. 服务端模板</a></div><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/sukkaw/disqusjs/dist/disqusjs.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/sukkaw/disqusjs/dist/disqus.js"></script><script type="text/javascript" id="disqus-count-script">$(function() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '//disqus.com/next/config.json', true);
  xhr.timeout = 2500;
  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4 && xhr.status === 200) {
      $('.post-meta .post-comments-count').show();
      var s = document.createElement('script');
      s.id = 'dsq-count-scr';
      s.src = 'https://counter2015.disqus.com/count.js';
      s.async = true;
      (document.head || document.body).appendChild(s);
    }
  };
  xhr.ontimeout = function () { xhr.abort(); };
  xhr.send(null);
});
</script><div class="comments" id="disqus_thread"><script type="text/javascript">// Load comments with DisqusJS
function loadComments() {
  window.dsqjs = new DisqusJS({
    shortname: 'counter2015',
    siteName: 'Not determined yet',
    identifier: '2019/11/06/scalatra8/',
    url: 'https://counter2015.github.io/blog/2019/11/06/scalatra8/',
    title: 'Scalatra in Action 8. 测试工程师要了杯啤酒',
    api: '',
    apikey: '',
    admin: '',
    adminLabel: ''
  });
}
// Lazy load {# Credit: https://github.com/theme-next/hexo-theme-next/blob/master/layout/_third-party/comments/disqus.swig #}
(function () {
  var offsetTop = document.getElementById('disqus_thread').offsetTop - window.innerHeight;
  if (offsetTop <= 0) {
    // Load directly when there's no scrollbar
    window.addEventListener('load', loadComments, false);
  } else {
    var disqusScroll = function () {
      // offsetTop may changes because of manually resizing browser window or lazy loading images
      var offsetTop = document.getElementById('disqus_thread').offsetTop - window.innerHeight;
      var scrollTop = window.scrollY;

      // Pre-load comments a bit? (margin or anything else)
      if (offsetTop - scrollTop < 60) {
        window.removeEventListener('scroll', disqusScroll);
        loadComments();
      }
    };
    window.addEventListener('scroll', disqusScroll);
  }
})();
// Scroll to comments automatically if #comment-xxx anchor specified
window.addEventListener('load', function () {
  // I don't know why, it just works.
  window.setTimeout(function () {
    if (location.hash.indexOf('#comment-') !== -1) {
      document.getElementById('disqus_thread').scrollIntoView(true);
    }
  }, 100);
}, false);
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://counter2015.github.io/blog"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/Bugfix/">Bugfix</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/puzzles/">puzzles</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E5%85%B6%E4%BB%96/">其他</a></li><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E6%8A%80%E6%9C%AF/">技术</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/%E6%8A%80%E6%9C%AF/%E9%83%A8%E7%BD%B2/">部署</a></li></ul></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/blog/tags/Flag/" style="font-size: 15px;">Flag</a> <a href="/blog/tags/kafka/" style="font-size: 15px;">kafka</a> <a href="/blog/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/blog/tags/%E4%BC%9A%E8%AE%AE/" style="font-size: 15px;">会议</a> <a href="/blog/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/blog/tags/%E5%A4%87%E5%BF%98/" style="font-size: 15px;">备忘</a> <a href="/blog/tags/redis/" style="font-size: 15px;">redis</a> <a href="/blog/tags/giter8/" style="font-size: 15px;">giter8</a> <a href="/blog/tags/%E5%9B%BE%E5%BA%8A/" style="font-size: 15px;">图床</a> <a href="/blog/tags/confluent/" style="font-size: 15px;">confluent</a> <a href="/blog/tags/hbase/" style="font-size: 15px;">hbase</a> <a href="/blog/tags/Github-Actions/" style="font-size: 15px;">Github Actions</a> <a href="/blog/tags/Bing/" style="font-size: 15px;">Bing</a> <a href="/blog/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/blog/tags/jvm/" style="font-size: 15px;">jvm</a> <a href="/blog/tags/%E6%9D%82%E8%B0%88/" style="font-size: 15px;">杂谈</a> <a href="/blog/tags/scala/" style="font-size: 15px;">scala</a> <a href="/blog/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">读书笔记</a> <a href="/blog/tags/PostgreSQL/" style="font-size: 15px;">PostgreSQL</a> <a href="/blog/tags/SQL/" style="font-size: 15px;">SQL</a> <a href="/blog/tags/Manjaro/" style="font-size: 15px;">Manjaro</a> <a href="/blog/tags/Scalatra/" style="font-size: 15px;">Scalatra</a> <a href="/blog/tags/zookeeper/" style="font-size: 15px;">zookeeper</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/2020/05/10/github-action/">Github Actions 实战——下载每日Bing图片</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/04/19/scalatra9/">Scalatra in Action 9. 配置、编译和部署</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/01/21/manjaro/">Manjaro 安装配置</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2020/01/02/2019-end/">年终碎碎念和来年Flag</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/12/16/linux-io-scheduler/">Linux I/O调度器备忘</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/11/06/scalatra8/">Scalatra in Action 8. 测试工程师要了杯啤酒</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/08/26/scalatra7/">Scalatra in Action 7. 服务端模板</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/08/22/postgresql/">PostgreSQL 快速使用指南</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/06/30/scalatra6/">Scalatra in Action 6. 处理文件</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/2019/04/29/bug2/">github pages微博图床图片无法显示</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//counter2015.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://wiki.hushhw.cn" title="hushhw's blog 身经百战见得多了" target="_blank">hushhw's blog 身经百战见得多了</a><ul></ul><a href="https://blog.iseki.space" title="isekiのNote" target="_blank">isekiのNote</a><ul></ul><a href="https://razertory.github.io" title="Razetory的技术博客" target="_blank">Razetory的技术博客</a><ul></ul><a href="https://blog.ajin.cloud" title="ajin的博客" target="_blank">ajin的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/blog/." rel="nofollow">Not determined yet.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/blog/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/blog/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/blog/css/copycode.css"><script type="text/javascript" src="/blog/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/blog/js/smartresize.js?v=1.0.0"></script></div></body></html>